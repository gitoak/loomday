#!/bin/bash

if command -v pwsh &> /dev/null && [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" || "$OSTYPE" == "cygwin" ]]; then
    HOOK_DIR="$(dirname "$0")"
    pwsh -NoProfile -ExecutionPolicy Bypass -File "$HOOK_DIR/pre-commit.ps1"
    exit $?
fi

set -e

echo "🔍 Running pre-commit checks..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.dart$" || true)

if [ -z "$STAGED_DART_FILES" ]; then
    echo "✅ No Dart files staged for commit"
    exit 0
fi

echo "📝 Staged Dart files:"
echo "$STAGED_DART_FILES"
echo ""

echo "🎨 Formatting Dart files..."
for file in $STAGED_DART_FILES; do
    if [ -f "$file" ]; then
        dart format "$file"
        git add "$file"
    fi
done
echo -e "${GREEN}✓${NC} Formatting complete"
echo ""

echo "🔬 Running dart analyze..."
if dart analyze --fatal-infos; then
    echo -e "${GREEN}✓${NC} Analysis passed"
else
    echo -e "${RED}✗${NC} Analysis failed"
    echo -e "${YELLOW}Please fix the issues above before committing${NC}"
    exit 1
fi
echo ""

echo "🔧 Checking for available fixes..."
FIXES=$(dart fix --dry-run 2>&1 || true)
if echo "$FIXES" | grep -q "Nothing to fix"; then
    echo -e "${GREEN}✓${NC} No fixable issues found"
else
    echo -e "${YELLOW}⚠${NC}  Some issues can be auto-fixed with 'dart fix --apply'"
    echo "$FIXES"
fi
echo ""

echo -e "${GREEN}✅ All pre-commit checks passed!${NC}"
exit 0
